///$tab Binary
BINARY [0a0aa303-7ee5-41a5-a4e2-5e64d1a1b7d2];
///$tab Main
SET ThousandSep=',';
SET DecimalSep='.';
SET MoneyThousandSep=',';
SET MoneyDecimalSep='.';
SET MoneyFormat='£#,##0.00;-£#,##0.00';
SET TimeFormat='hh:mm:ss';
SET DateFormat='DD/MM/YYYY';
SET TimestampFormat='DD/MM/YYYY hh:mm:ss[.fff]';
SET FirstWeekDay=0;
SET BrokenWeeks=1;
SET ReferenceDay=0;
SET FirstMonthOfYear=1;
SET CollationLocale='en-GB';
SET CreateSearchIndexOnReload=1;
SET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';
SET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';
SET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';
SET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';

///$tab Calendar
[autoCalendar]: 
  DECLARE FIELD DEFINITION Tagged ('$date')
FIELDS
  Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),
  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter', '$cyclic'),
  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$yearquarter', '$qualified'),
  Dual('Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [_YearQuarter] Tagged ('$yearquarter', '$hidden', '$simplified'),
  Month($1) AS [Month] Tagged ('$month', '$cyclic'),
  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth', '$qualified'),
  Dual(Month($1), monthstart($1)) AS [_YearMonth] Tagged ('$axis', '$yearmonth', '$simplified', '$hidden'),
  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber', '$cyclic'),
  Date(Floor($1)) AS [Date] Tagged ('$axis', '$date', '$qualified'),
  Date(Floor($1), 'D') AS [_Date] Tagged ('$axis', '$date', '$hidden', '$simplified'),
  If (DayNumberOfYear($1) <= DayNumberOfYear(Today()), 1, 0) AS [InYTD] ,
  Year(Today())-Year($1) AS [YearsAgo] ,
  If (DayNumberOfQuarter($1) <= DayNumberOfQuarter(Today()),1,0) AS [InQTD] ,
  4*Year(Today())+Ceil(Month(Today())/3)-4*Year($1)-Ceil(Month($1)/3) AS [QuartersAgo] ,
  Ceil(Month(Today())/3)-Ceil(Month($1)/3) AS [QuarterRelNo] ,
  If(Day($1)<=Day(Today()),1,0) AS [InMTD] ,
  12*Year(Today())+Month(Today())-12*Year($1)-Month($1) AS [MonthsAgo] ,
  Month(Today())-Month($1) AS [MonthRelNo] ,
  If(WeekDay($1)<=WeekDay(Today()),1,0) AS [InWTD] ,
  (WeekStart(Today())-WeekStart($1))/7 AS [WeeksAgo] ,
  Week(Today())-Week($1) AS [WeekRelNo] ;

DERIVE FIELDS FROM FIELDS [OrderDate] USING [autoCalendar] ;
///$tab Distribution List
Replace LOAD
    "Name" AS [DL_DISTRIBUTION_RECIPIENT_NAME],
    "Email" AS [DL_DISTRIBUTION_EMAIL],
    SubField([Filters],',') AS [DL_DISTRIBUTION_FILTERS],
    SubField([Groups],',') AS [DL_DISTRIBUTION_GROUP_NAMES]
FROM "lib://:DataFiles/SampleFile (2).xlsx"
(ooxml, embedded labels, table is DL_DISTRIBUTION_SVC_USERS_QCS);

TempGroups:
  REPLACE LOAD
      *
    FROM "lib://:DataFiles/SampleFile (2).xlsx"
    (ooxml, embedded labels, table is DL_DISTRIBUTION_SVC_GROUPS_QCS);

let vEnabledFieldNo = FieldNumber('Enabled', 'TempGroups');

if (vEnabledFieldNo > 0) then
    DL_DISTRIBUTION_SVC_GROUPS_QCS:
    REPLACE LOAD
        "Name" AS [DL_DISTRIBUTION_GROUP_NAMES],
        "Description" AS [DL_DISTRIBUTION_GROUP_DESCRIPTION],
        "Enabled" AS [DL_DISTRIBUTION_GROUP_ENABLED]
    Resident TempGroups;
else

    DL_DISTRIBUTION_SVC_GROUPS_QCS:
    REPLACE LOAD
        "Name" AS [DL_DISTRIBUTION_GROUP_NAMES],
        "Description" AS [DL_DISTRIBUTION_GROUP_DESCRIPTION],
        1 AS [DL_DISTRIBUTION_GROUP_ENABLED]
    Resident TempGroups;
end if

Drop Table TempGroups;

tag field DL_DISTRIBUTION_RECIPIENT_NAME with 'DL_DISTRIBUTION_SVC__recipientName';
tag field DL_DISTRIBUTION_EMAIL with 'DL_DISTRIBUTION_SVC__recipientEmail';
tag field DL_DISTRIBUTION_FILTERS with 'DL_DISTRIBUTION_SVC__recipientFilters';
tag field DL_DISTRIBUTION_GROUP_NAMES with 'DL_DISTRIBUTION_SVC__groupsName';
tag field DL_DISTRIBUTION_GROUP_DESCRIPTION with 'DL_DISTRIBUTION_SVC__groupDescription';
tag field DL_DISTRIBUTION_GROUP_ENABLED with 'DL_DISTRIBUTION_SVC__groupEnabled';

///$tab Section
Orders_Temp:
NoConcatenate
LOAD
	*,
    Text(OrderID) as OrdersTemp
RESIDENT orders
;

DROP TABLE orders;
RENAME TABLE Orders_Temp TO orders;